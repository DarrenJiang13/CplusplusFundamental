# 2.2 调度

## 2.2.1 处理机调度的概念，层次
### **知识总览**
- 基本概念
- 三个层次
    - 高级调度-作业调度
    - 中级调度-内存调度
    - 低级调度-进程调度
- 三层调度的联系，对比
- 补充知识
    - 进程的挂起态
    - 七状态模型

### **基本概念**
当有一堆任务要处理，但是因为资源有限，没法同时处理，这就需要某种规则来决定这些人物的顺序，这就是调度研究的问题。  
多道程序系统中，进程数量往往多于处理机的个数。处理机调度，就是从就绪队列中按照一定的算法选择一个进程并将处理机分配给它运行。

### **三个层次**
- 高级调度（作业调度） 
    - 按一定的原则从外存上处于后备队列的作业中挑选一个或多个作业，给他们分配内存等基本资源，并建立相应的进程（PCB）使得他们获得竞争处理机的权利
    - 是外存内存之间的调度。每个作业只调入一次，调出一次。作业调入时会建立相应的PCB，作业调出时才撤销PCB。
    - 高级调度主要是解决调入的问题，只有调入的时候要选择事件，而调出的时候只要程序运行结束即可。
- 中级调度(内存调度)
    - 引入虚拟存储技术之后，可将暂时不能运行的进程调至外存等待。等他重新具备了运行条件且内存又稍有空闲时，再重新调入内存。 中级调度，就是要决定将哪个处于挂起状态的进程重新调入内存。
    - 目的： 提高内存利用率和系统吞吐量。
    - 暂时调到外存的进程状态为挂起状态。PCB不会调到外存，二十常驻内存。 PCB会记录进程数据在外存中的存放位置，进程状态等信息。 被挂起的进程PCB会被放到挂起队列中。
    - 一个进程可能被多次调出，调入内存，因此中级调度频率比高级调度更高。
- 低级调度（进程调度）
    - 主要任务是按照某种方法和策略从就绪队列中选取一个进程，将处理机分配给他
    - 进程调度是最基本的一种调度，在一般的操作系统中必须配置进程调度
    - 频率高，一般几十毫秒一次

### **三层调度的联系，对比**
|                       | 要做什么                                                         | 发生地               | 频率 | 进程状态                      |
| --------------------- | -------------------------------------------------------------------- | ----------------------- | ---- | --------------------------------- |
| 高级调度（作业调度） | 按照某种规则，从后备队列中选择合适的作业将其调入内存，并为其创建进程 | 外存->内存（面向作业） | 最低 | 无->创建态->就绪态         |
| 中级调度（内存调度） | 按照某种规则，从挂起队列中选择合适的进程将其数据调回内存 | 外存->内存（面向进程） | 中等 | 挂起态->就绪态(阻塞挂起->阻塞态) |
| 低级调度（进程调度） | 按照某种规则，从就绪队列中选择合适的进程将其分配处理机 | 内存->CPU             | 最高 | 就绪态->运行态              |
    
### **补充知识**
- 暂时调到外存等待的进程状态为挂起态
- 挂起态又可以进一步细分为就绪挂起，阻塞挂起两种状态。
- 挂起与阻塞区别：
    挂起态进程在外存，阻塞仍在内存

### **知识回顾**
- 基本概念：按某种算法选择一个进程将处理机分配给他
- 三个层次
    - 高级调度-作业调度：按照某种规则，从后备队列中选择合适的作业将其调入内存，并为其创建进程
    - 中级调度-内存调度：按照某种规则，从挂起队列中选择合适的进程将其数据调回内存
    - 低级调度-进程调度：按照某种规则，从就绪队列中选择合适的进程将其分配处理机
- 三层调度的联系，对比
    - 高级调度
        - 外存->内存（面向作业）
        - 频率最低
    - 中级调度
        - 外存->内存（面向进程）
        - 频率中等
    - 低级调度
        - 内存->CPU
        - 频率最高
- 补充知识
    - 进程的挂起态
    - 七状态模型：五状态模型+“就绪挂起”+“阻塞挂起”

## 2.2.2 进程调度的时机、切换与过程、方式
### **知识总览**
- 时机
    - 何时需要进程调度
    - 何时不需要进程调度
- 方式
    - 非剥夺调度方式
    - 剥夺调度方式
- 切换与过程
    - 调度与切换的区别
    - 进程切换时需要做什么

### **进程调度的时机**
- 需要进行进程调度
    - 当前运行的进程**主动**放弃处理机
        - 进程正常终止
        - 进程发生异常而终止
        - 进程主动请求阻塞
    - 当前运行的进程**被动**放弃处理机
        - 分配的时间片用完
        - 有更紧急的事需要处理(I/O中断)
        - 有更高优先级的进程进入就绪队列
- 不能进行进程调度
    - 处理**中断**的过程中。 中断处理复杂，与硬件密切相关，很难在中断处理时进行进程切换
    - 进程在**操作系统内核程序临界区**中
    - 在**原子操作**过程中。 原子操作不可中断，要一起呵成。

### **进程调度的方式**
- 非剥夺调度方式：“我先走”。只允许进程主动放弃处理机，在运行中即使有更紧迫的任务到达，仍要等到该进程终止或者主动要求进入阻塞态
- 剥夺调度方式：“让人民群众先走”。当一个进程正在处理机上执行时，如果有一个更加重要或者更紧迫的进程需要使用处理机，则立即暂停正在执行的进程，将处理机分配给更重要紧迫的那个进程。

### **进程的切换与过程**
- 狭义的进程调度与进程切换的区别
    - 狭义进程调度： 从就绪队列中选中一个要运行的进程
    - 进程切换：一个进程让出处理机，另一个进程占用处理机
- 广义的进程调度一般包含了选择进程和进程切换两个步骤

### **知识回顾**
- 时机
    - 何时需要进程调度
        - **主动**放弃处理机
            - 进程正常终止
            - 进程发生异常而终止
            - 进程主动请求阻塞
        - **被动**放弃处理机
            - 分配的时间片用完
            - 有更紧急的事需要处理(I/O中断)
            - 有更高优先级的进程进入就绪队列
    - 何时不能进程调度
        - 处理**中断**的过程中。 
        - 进程在**操作系统内核程序临界区**中
        - 在**原子操作**过程中。。
- 方式
    - 非剥夺调度方式：只能由当前进程主动放弃CPU
    - 剥夺调度方式：可由操作系统剥夺当前进程的CPU使用权
- 切换与过程
    - 调度与切换的区别
    - 切换过程
        - 对原来的进程进行数据保存
        - 对新的进程进行数据恢复
    - 调度、切换有代价，并不是调度越频繁，并发度越高

## 2.2.3 调度算法的评价指标
### **知识总览**
- CPU利用率
- 系统吞吐量
- 周转时间
    - 周转时间，平均周转时间
    - 带权周转时间，平均带权周转时间
- 等待时间
- 响应时间

### **CPU利用率**
> 忙碌的时间/总时间
### **系统吞吐量**
> 单位时间内完成作业的道数
### **周转时间**
> 作业提交给系统开始，到作业完成为止的这段时间间隔
- 时间组成：
    - 作业在外存后备队列上等待作业调度的时间
    - 进程在就绪队列上等待进程调度的时间
    - 进程在CPU上的时间
    - 进程等待I/O操作完成的时间
- 周转时间=作业完成时间-作业提交时间
- 平均周转时间=周转时间之和/作业数
- 带权周转时间=作业周转时间/作业实际运行的时间
- 平均带权周转时间=带权周转时间和/作业数
### **等待时间**
> 作业/进程处于等待处理机状态之和
- 对进程
    进程建立后等待被服务的时间之和
- 对作业
    不仅建立进程后的等待时间，还要加上作业在外存后备队列中的等待时间
### **响应时间**
> 用户提交请求到首次产生响应所用的时间

### **知识回顾**
- CPU利用率：忙碌的时间/总时间
- 系统吞吐量：完成作业的道数/总时间
- 周转时间
    - 周转时间=作业完成时间-作业提交时间
    - 平均周转时间=周转时间之和/作业数
    - 带权周转时间=作业周转时间/作业实际运行的时间
    - 平均带权周转时间=带权周转时间和/作业数
- 等待时间
    作业/进程处于等待处理机状态之和
- 响应时间
    用户提交请求到首次产生响应所用的时间

## 2.2.4 FCFS、SJF、HRRN调度算法
### **知识总览**
- 先来先服务（FCFS）
- 短作业优先（SJF）
- 高响应比优先（HRRN）

### **先来先服务（FCFS）**
- 算法思想：公平
- 算法规则： 按照作业/进程到达的先后顺序进行服务
- 用于作业调度 or 进程调度？
    - 作业调度：考虑哪个作业先到达后备队列
    - 进程调度： 哪个进程先到达就绪队列
- 抢占式 or 非抢占式： 非抢占式算法
- 优点，缺点
    - 优点：公平，算法实现简单
    - 缺点： 长作业后面的短作业需要等待很长时间，带权周转时间非常大，对短作业来说用户体验不好
- 是否会导致饥饿： 不会

### **短作业优先（SJF）**
- 算法思想：最少的平均等待时间、平均周转时间、平均带权周转时间
- 算法规则：最短（要求服务时间）的作业/进程优先得到服务
- 用于作业调度 or 进程调度？均可
    - 用于进程调度时候称为短进程优先 SPF
- 抢占式 or 非抢占式： 非抢占式。 抢占式版本：最短剩余时间优先 SRTN
- 优点，缺点
    - 优点：最短的平均等待和平均周转时间
    - 缺点：不公平。 对作业有利，长作业不利，可能产生饥饿现象
- 是否会导致饥饿： 会。源源不断的短作业/进程会使得长作业/进程一直得不到服务

### **高响应比优先（HRRN）**
- 算法思想：综合考虑作业/进程的等待时间和要求服务的时间
- 算法规则：每次调度时先计算响应比（（等待时间+要求服务时间）/要求服务时间）
- 用于作业调度 or 进程调度？均可
- 抢占式 or 非抢占式
    非抢占式，只有当前运行的作业/进程主动放弃处理机时，才能开始计算响应比。
- 优点，缺点
    - 优点：
        - 综合考虑了等待时间和运行时间
        - 等待时间相同，要求服务时间短的优先(SJF)
        - 要求服务时间相同时，等待时间长的优先（FCFS）
        - 对于长作业，等待时间变久，响应比变大，避免饥饿

- 是否会导致饥饿： 不会。

## 2.2.5 调度算法：时间片轮转、优先级调度，多级反馈队列
### **知识总览**
- 时间片轮转调度（RR）
- 优先级调度
- 多级反馈队列调度

